<!DOCTYPE html>
<html>

<head>
    <title>Integer map designer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            margin: 0px;
        }
    </style>
</head>

<body>
    <header class="mdc-top-app-bar">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">

                <span class="mdc-top-app-bar__title">Integer Map Designer</span>
            </section>
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" onclick="download()"
                    aria-label="Download file">file_download</button>
            </section>
        </div>
    </header>
    <main class="mdc-top-app-bar--fixed-adjust">
        <canvas id="myCanvas" width="1024" height="1024" style="border:1px solid #000000;"></canvas>

        <div class="mdc-slider mdc-slider--discrete">
            <input class="mdc-slider__input" type="range" min="2" max="256" value="16" name="resolution" step="1"
                aria-label="Discrete slider resolution">
            <div class="mdc-slider__track">
                <div class="mdc-slider__track--inactive"></div>
                <div class="mdc-slider__track--active">
                    <div class="mdc-slider__track--active_fill"></div>
                </div>
            </div>
            <div class="mdc-slider__thumb">
                <div class="mdc-slider__value-indicator-container" aria-hidden="true">
                    <div class="mdc-slider__value-indicator">
                        <span class="mdc-slider__value-indicator-text">
                            16
                        </span>
                    </div>
                </div>
                <div class="mdc-slider__thumb-knob"></div>
            </div>
        </div>
    </main>



    <script>
        let resol = 32
        let slider
        let c
        let isDrawing = false
        let lastMouseButton = 0
        let musX = 0
        let musY = 0
        let data = []

        function resolutionChanged() {
            resol = slider.getValue()
            data = Array(resol * resol).fill(0)

            drawGrid()
        }

        function drawGrid() {

            let ctx = c.getContext("2d")
            ctx.clearRect(0, 0, c.width, c.height)

            for (let x = 0; x < resol; x++) {
                let xx = c.width / resol;
                let xxx = x * xx;
                ctx.beginPath()
                ctx.moveTo(xxx, 0)
                ctx.lineTo(xxx, c.height)
                ctx.stroke()

                let yy = c.height / resol;
                let yyy = x * yy;
                ctx.beginPath()
                ctx.moveTo(0, yyy)
                ctx.lineTo(c.width, yyy)
                ctx.stroke()
            }

            for (let x = 0; x < resol; x++) {
                for (let y = 0; y < resol; y++) {
                    if (data[resol * y + x] == 1) {
                        let xInterval = c.width / resol;
                        let yInterval = c.height / resol;
                        ctx.fillStyle = "black";
                        ctx.fill();
                        ctx.fillRect(xInterval * x, yInterval * y, xInterval, yInterval)
                    }
                }
            }
        }

        function modifyTile(shouldErase) {
            let xInterval = c.width / resol
            let yInterval = c.height / resol

            let xx = Math.floor(musX / xInterval)
            let yy = Math.floor(musY / yInterval)

            data[resol * yy + xx] = shouldErase ? 0 : 1

            drawGrid()
        }

        c = document.getElementById("myCanvas")
        c.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); }

        c.addEventListener('mousedown', e => {
            musX = e.offsetX;
            musY = e.offsetY;
            isDrawing = true;

            lastMouseButton = e.button

            switch (e.button) {
                    case 0:
                        modifyTile(false)
                        break;
                    case 2:
                        modifyTile(true)
                        break;
                }
        });

        c.addEventListener('mousemove', e => {
            if (isDrawing === true) {
                musX = e.offsetX
                musY = e.offsetY

                switch (lastMouseButton) {
                    case 0:
                        modifyTile(false)
                        break;
                    case 2:
                        modifyTile(true)
                        break;
                }
            }
        });

        window.addEventListener('mouseup', e => {
            if (isDrawing === true) {
                musX = 0;
                musY = 0;
                isDrawing = false;
            }
        });

        // Instantiation
        const topAppBarElement = document.querySelector('.mdc-top-app-bar');
        const topAppBar = new mdc.topAppBar.MDCTopAppBar(topAppBarElement);
        slider = new mdc.slider.MDCSlider(document.querySelector('.mdc-slider'));
        const buttons = document.querySelectorAll(".mdc-button");
        for (const button of buttons) {
            mdc.ripple.MDCRipple.attachTo(button);
        }

        resolutionChanged()
        document.querySelector('.mdc-slider').addEventListener("MDCSlider:change", resolutionChanged)

        function download() {
            let counter = 0
            let dataString = ""
            for (let i = 0; i < data.length; i++) {
                counter++
                dataString += data[i]

                // Add commas between values
                if (i != data.length - 1) {
                    dataString += ", "
                }

                // Append a new line to match the grid
                if (counter == resol) {
                    dataString += "\n"
                    counter = 0
                }

            }

            let element = document.createElement("a")
            element.setAttribute("href", "data:text/plan;charset=utf-8," + encodeURIComponent(dataString))
            element.setAttribute("download", "map.txt")
            element.style.display = "none"
            document.body.appendChild(element)
            element.click()
            document.body.removeChild(element)
        }
    </script>
</body>

</html>